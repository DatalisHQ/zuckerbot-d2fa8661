import { useState, useEffect } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { RefreshCw, ExternalLink, Calendar, Globe, Smartphone, Monitor } from \"lucide-react\";\nimport { supabase } from \"@/integrations/supabase/client\";\nimport { useNavigate } from \"react-router-dom\";\n\ninterface PreviewLog {\n  id: string;\n  url: string | null;\n  business_name: string | null;\n  created_at: string;\n  success: boolean;\n  has_images: boolean;\n  image_count: number;\n  ip_address: string | null;\n  user_agent: string | null;\n  saved_image_urls?: string[];\n  generated_ads?: any;\n}\n\nexport default function AdAudit() {\n  const [logs, setLogs] = useState<PreviewLog[]>([]);\n  const [loading, setLoading] = useState(true);\n  const navigate = useNavigate();\n\n  useEffect(() => {\n    checkAuth();\n    loadLogs();\n  }, []);\n\n  const checkAuth = async () => {\n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user || user.email !== \"davisgrainger@gmail.com\") {\n      navigate(\"/auth\");\n      return;\n    }\n  };\n\n  const loadLogs = async () => {\n    setLoading(true);\n    try {\n      const { data, error } = await supabase\n        .from(\"preview_logs\")\n        .select(\"*\")\n        .eq(\"success\", true)\n        .order(\"created_at\", { ascending: false })\n        .limit(50);\n\n      if (error) {\n        console.error(\"Error loading logs:\", error);\n        return;\n      }\n\n      setLogs(data || []);\n    } catch (error) {\n      console.error(\"Error:\", error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const regenerateAd = async (url: string) => {\n    if (!url) return;\n    \n    try {\n      const response = await fetch(\"/api/preview\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ url }),\n      });\n      \n      if (response.ok) {\n        const result = await response.json();\n        console.log(\"Regenerated ad:\", result);\n        // Could show in a modal or open in new tab\n      }\n    } catch (error) {\n      console.error(\"Failed to regenerate:\", error);\n    }\n  };\n\n  const getDeviceInfo = (userAgent: string | null) => {\n    if (!userAgent) return { icon: Monitor, text: \"Unknown\" };\n    \n    if (userAgent.includes(\"Mobile\") || userAgent.includes(\"Android\")) {\n      return { icon: Smartphone, text: \"Mobile\" };\n    }\n    return { icon: Monitor, text: \"Desktop\" };\n  };\n\n  const formatDate = (dateString: string) => {\n    const date = new Date(dateString);\n    const now = new Date();\n    const diffMs = now.getTime() - date.getTime();\n    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));\n    const diffDays = Math.floor(diffHours / 24);\n\n    if (diffHours < 1) return \"Just now\";\n    if (diffHours < 24) return `${diffHours}h ago`;\n    if (diffDays < 7) return `${diffDays}d ago`;\n    \n    return date.toLocaleDateString();\n  };\n\n  return (\n    <div className=\"container mx-auto px-4 py-8 max-w-7xl\">\n      <div className=\"mb-8\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div>\n            <h1 className=\"text-3xl font-bold mb-2\">Ad Generation Audit</h1>\n            <p className=\"text-muted-foreground\">\n              Review generated ads to debug conversion issues\n            </p>\n          </div>\n          <Button onClick={loadLogs} disabled={loading}>\n            <RefreshCw className={`w-4 h-4 mr-2 ${loading ? 'animate-spin' : ''}`} />\n            Refresh\n          </Button>\n        </div>\n        \n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6\">\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"text-2xl font-bold\">{logs.length}</div>\n              <p className=\"text-xs text-muted-foreground\">Total Tests</p>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"text-2xl font-bold\">\n                {logs.filter(l => new Date(l.created_at) > new Date(Date.now() - 24*60*60*1000)).length}\n              </div>\n              <p className=\"text-xs text-muted-foreground\">Last 24h</p>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"text-2xl font-bold\">\n                {logs.filter(l => l.has_images).length}\n              </div>\n              <p className=\"text-xs text-muted-foreground\">With Images</p>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"text-2xl font-bold\">\n                {Math.round(logs.filter(l => l.has_images).length / logs.length * 100) || 0}%\n              </div>\n              <p className=\"text-xs text-muted-foreground\">Success Rate</p>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {loading ? (\n        <div className=\"text-center py-8\">Loading ad tests...</div>\n      ) : (\n        <div className=\"space-y-4\">\n          {logs.map((log) => {\n            const deviceInfo = getDeviceInfo(log.user_agent);\n            const DeviceIcon = deviceInfo.icon;\n            \n            return (\n              <Card key={log.id} className=\"hover:shadow-lg transition-shadow\">\n                <CardHeader>\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <CardTitle className=\"text-lg mb-2 flex items-center gap-2\">\n                        <span className=\"truncate\">\n                          {log.business_name || \"Unknown Business\"}\n                        </span>\n                        {log.has_images && (\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {log.image_count} images\n                          </Badge>\n                        )}\n                      </CardTitle>\n                      \n                      <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n                        <div className=\"flex items-center gap-1\">\n                          <Calendar className=\"w-4 h-4\" />\n                          {formatDate(log.created_at)}\n                        </div>\n                        \n                        {log.url && (\n                          <div className=\"flex items-center gap-1\">\n                            <Globe className=\"w-4 h-4\" />\n                            <span className=\"truncate max-w-xs\">{log.url}</span>\n                          </div>\n                        )}\n                        \n                        <div className=\"flex items-center gap-1\">\n                          <DeviceIcon className=\"w-4 h-4\" />\n                          {deviceInfo.text}\n                        </div>\n                        \n                        {log.ip_address && (\n                          <Badge variant=\"secondary\" className=\"text-xs\">\n                            {log.ip_address}\n                          </Badge>\n                        )}\n                      </div>\n                    </div>\n                    \n                    <div className=\"flex items-center gap-2\">\n                      {log.url && (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => window.open(log.url!, '_blank')}\n                        >\n                          <ExternalLink className=\"w-4 h-4 mr-1\" />\n                          Visit\n                        </Button>\n                      )}\n                      \n                      {log.url && (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => regenerateAd(log.url!)}\n                        >\n                          Test Again\n                        </Button>\n                      )}\n                    </div>\n                  </div>\n                </CardHeader>\n                \n                <CardContent>\n                  {/* Display generated ads if available */}\n                  {log.generated_ads && Array.isArray(log.generated_ads) && (\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\n                      {log.generated_ads.map((ad: any, i: number) => (\n                        <div key={i} className=\"border rounded-lg p-4 bg-muted/30\">\n                          <div className=\"font-medium text-sm mb-1\">\n                            {ad.headline || `Ad ${i + 1} Headline`}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground\">\n                            {ad.copy || `Ad ${i + 1} copy text`}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                  \n                  {/* Display saved images if available */}\n                  {log.saved_image_urls && log.saved_image_urls.length > 0 && (\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2\">\n                      {log.saved_image_urls.map((url: string, i: number) => (\n                        <div key={i} className=\"aspect-square bg-muted rounded-lg overflow-hidden\">\n                          <img \n                            src={url} \n                            alt={`Generated ad ${i + 1}`}\n                            className=\"w-full h-full object-cover hover:scale-105 transition-transform cursor-pointer\"\n                            onClick={() => window.open(url, '_blank')}\n                          />\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                  \n                  {/* Fallback if no ads/images stored */}\n                  {!log.generated_ads && !log.saved_image_urls && (\n                    <div className=\"text-sm text-muted-foreground italic\">\n                      Ad details not stored (generated before audit system)\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n"